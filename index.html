<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Sports Team Org Structure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif; /* Updated to Roboto as per persona typography */
            background-color: var(--light-bg);
            color: var(--light-text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden; /* Prevent horizontal scroll on body */
        }
        h1, h2, .font-header {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
        }

        :root {
            /* Primary Background Colors - Exact persona colors */
            --light-bg: #121212; /* Main background - primary persona background */
            --light-bg-secondary: #1C2226; /* Secondary background - shade of black for contrast */
            
            /* Text Colors - High contrast for readability on dark background */
            --light-text-primary: #FFFFFF; /* Primary text - white for maximum readability */
            --light-text-secondary: #6A727E; /* Secondary text - extra accent gray from personas */
            
            /* Border and Divider Colors */
            --light-border: #1C2226; /* Borders - using secondary background for subtle separation */
            
            /* Department Colors - Mapped to exact persona colors */
            --light-accent1: #0F28FF; /* Primary accent/buttons - persona secondary blue */
            --light-accent1-hover: #0E23E6; /* Hover state for primary accent - darker blue */
            --light-accent2: #53DA3F; /* Coaching - persona green */
            --light-accent3: #FF7300; /* Management - persona orange */
            --light-accent4: #FF421D; /* Medical - persona accent red */
            --light-accent5: #FFDD00; /* Analysis - persona yellow */
            --light-accent6: #6A727E; /* Inactive elements - persona extra accent gray */
        }

        /* View Switching Buttons - Updated for smaller size */
        .view-btn {
            display: inline-flex;
            align-items: center;
            font-weight: 500;
            font-size: 0.875rem; /* Smaller font size (text-sm) */
            padding: 0.4rem 0.8rem; /* Reduced padding */
            border-radius: 0; /* Removed border-radius for 90 degree corners */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        .view-btn svg { /* Adjust SVG size in buttons */
            width: 0.875rem; /* 14px */
            height: 0.875rem; /* 14px */
            margin-right: 0.375rem; /* Reduced margin */
        }

        .view-btn.active {
            background-color: var(--light-accent1);
            color: white;
            border-color: var(--light-accent1);
        }
        .view-btn.active:hover {
            background-color: var(--light-accent1-hover);
        }
        .view-btn.inactive {
            background-color: var(--light-bg);
            color: var(--light-text-secondary);
            border-color: var(--light-border);
        }
        .view-btn.inactive:hover {
            background-color: var(--light-bg-secondary);
            border-color: var(--light-accent6);
            color: var(--light-text-primary);
        }

        .clickable-row { cursor: pointer; }
        .view-container { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .hidden-view { opacity: 0; transform: translateY(10px); height: 0; overflow: hidden; display: none !important; }
        .visible-view { opacity: 1; transform: translateY(0); height: auto; display: block; }

        /* Modal Styling */
        .modal {
            transition: opacity 0.25s ease-out, transform 0.25s ease-out;
            backdrop-filter: blur(4px);
        }
        .modal-hidden { opacity: 0; transform: scale(0.95) translateY(10px); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }

        #modal-content-wrapper {
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        #modal-body-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        #modal-description {
            padding-right: 0.5rem; /* For scrollbar */
            font-size: 0.9rem;
            line-height: 1.6;
        }
        #modal-description ul { list-style: disc; margin-left: 1.5rem; margin-top: 0.75rem; margin-bottom: 0.75rem; }
        #modal-description li { margin-bottom: 0.35rem; }
        #modal-description strong { color: var(--light-accent1); font-weight: 600; }
        #modal-description p { margin-bottom: 0.75rem; }

        /* D3 Chart Specific Styles */
        #d3-chart-container {
            width: 100%;
            height: 650px;
            overflow: hidden;
            border: 1px solid var(--light-border);
            border-radius: 0; /* Removed border-radius for 90 degree corners */
            background-color: var(--light-bg-secondary); /* Dark secondary background for chart area */
            cursor: grab;
            position: relative;
        }
        #d3-chart-container:active {
            cursor: grabbing;
        }

        /* Zoom Control Buttons */
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .zoom-btn {
            width: 32px;
            height: 32px;
            background-color: var(--light-bg-secondary); /* Changed to secondary background for better visibility */
            border: 2px solid var(--light-text-primary); /* Increased border width and made it white */
            border-radius: 0; /* Removed border-radius for 90 degree corners */
            color: var(--light-text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 16px;
            font-weight: bold;
        }
        .zoom-btn:hover {
            background-color: var(--light-accent1); /* Bright blue background on hover */
            border-color: var(--light-accent1);
            color: var(--light-bg); /* Dark text on bright background */
        }

        .d3-node rect.node-rect {
            stroke-width: 1px;
            rx: 0; /* Removed corner radius for 90 degree corners */
            ry: 0; /* Removed corner radius for 90 degree corners */
            transition: fill 0.2s ease, stroke 0.2s ease, filter 0.2s ease;
            filter: drop-shadow(0px 1px 2px rgba(0,0,0,0.1));
        }
        .d3-node:hover rect.node-rect {
            filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.15)) brightness(0.97);
        }
        .d3-node text {
            pointer-events: none;
            font-family: 'Roboto', sans-serif; /* Updated to Roboto for consistency */
        }
        .d3-node text.node-name {
            font-size: 13px;
            font-weight: 600;
            fill: var(--light-text-primary); /* White text for dark theme */
        }
        .d3-node text.node-department-text {
            font-size: 10px;
            font-weight: 500;
            fill: white;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            dominant-baseline: middle;
        }
        .d3-link {
            fill: none;
            stroke: var(--light-text-primary); /* Updated to white for better visibility */
            stroke-width: 1.5px;
        }

        .badge-fill-coaching { fill: var(--light-accent2); } /* Green - #53DA3F */
        .badge-fill-medical { fill: var(--light-accent4); } /* Red - #FF421D */
        .badge-fill-management { fill: var(--light-accent3); } /* Orange - #FF7300 */
        .badge-fill-performance { fill: var(--light-accent5); } /* Yellow - #FFDD00 for analysis */
        .badge-fill-default { fill: var(--light-accent6); } /* Gray - #6A727E */

        .dept-badge {
            display: inline-block;
            padding: 3px 10px !important;
            border-radius: 0; /* Removed border-radius for 90 degree corners */
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            line-height: 1.3;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge-coaching { background-color: var(--light-accent2); } /* Green - #53DA3F */
        .badge-medical { background-color: var(--light-accent4); } /* Red - #FF421D */
        .badge-management { background-color: var(--light-accent3); } /* Orange - #FF7300 */
        .badge-performance { background-color: var(--light-accent5); } /* Yellow - #FFDD00 for analysis */
        .badge-default { background-color: var(--light-accent6); color: var(--light-text-primary); } /* Gray - #6A727E */

        .loader {
            border: 4px solid var(--light-bg-secondary);
            border-top: 4px solid var(--light-accent1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            height: 100%;
        }
        .chart-loading-container p {
            margin-top: 1rem;
            color: var(--light-text-secondary); /* Light gray text for loading message */
            font-size: 0.9rem;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col bg-[--light-bg]">
    <div class="container mx-auto max-w-full lg:max-w-7xl flex-grow flex flex-col">

        <header class="p-4 md:px-6 md:py-5 flex flex-wrap justify-between items-center border-b border-[--light-border]">
            <h1 class="text-xl sm:text-2xl md:text-3xl font-header text-[--light-text-primary] mb-3 sm:mb-0">
                Elite Sports Team Structure
            </h1>
            <div class="flex flex-wrap justify-start sm:justify-end gap-2 sm:gap-3">
                <button id="show-chart-btn" class="view-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M7 3a1 1 0 0 0-1 1v2.586a1 1 0 0 0 .293.707l5.414 5.414a1 1 0 0 0 .707.293H15a1 1 0 0 0 1-1v-2.586a1 1 0 0 0-.293-.707l-5.414-5.414A1 1 0 0 0 9.586 3H7ZM5 6.586a3 3 0 0 1-.879-2.121V4a3 3 0 0 1 3-3h2.586a3 3 0 0 1 2.121.879l5.414 5.414A3 3 0 0 1 18 10.414V13a3 3 0 0 1-3 3h-2.586a3 3 0 0 1-2.121-.879l-5.414-5.414A3 3 0 0 1 5 6.586Z" />
                        <path d="M3 7a1 1 0 0 1 1-1h2.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V15a1 1 0 0 1-1 1h-2.586a1 1 0 0 1-.707-.293l-5.414-5.414A1 1 0 0 1 3 8.586V7Z" />
                     </svg>
                    Org Chart
                </button>
                <button id="show-table-btn" class="view-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.25 3A2.25 2.25 0 0 0 2 5.25v9.5A2.25 2.25 0 0 0 4.25 17h11.5A2.25 2.25 0 0 0 18 14.75v-9.5A2.25 2.25 0 0 0 15.75 3H4.25ZM3.5 6.75v2.5h13v-2.5h-13Zm0 3.5v4.5A.75.75 0 0 0 4.25 15h11.5a.75.75 0 0 0 .75-.75v-4.5h-13Z" clip-rule="evenodd" />
                     </svg>
                    Table View
                </button>
            </div>
        </header>

        <main class="flex-grow p-4 md:px-6 md:py-6 overflow-auto">
            <div id="chart-view" class="view-container shadow-sm">
                <div id="d3-chart-container">
                     <div class="chart-loading-container">
                         <div class="loader"></div>
                         <p>Loading D3 Chart...</p>
                     </div>
                </div>
            </div>

            <div id="table-view" class="view-container bg-[--light-bg-secondary] border border-[--light-border] p-0 sm:p-4 md:p-6 overflow-x-auto shadow-sm">
                <table id="roles-table" class="min-w-full divide-y divide-[--light-border]">
                    <thead class="bg-[--light-bg-secondary]">
                        <tr>
                            <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-[--light-text-secondary] uppercase tracking-wider">Role</th>
                            <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-[--light-text-secondary] uppercase tracking-wider">Reports To</th>
                            <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-[--light-text-secondary] uppercase tracking-wider">Department</th>
                        </tr>
                    </thead>
                    <tbody class="bg-[--light-bg] divide-y divide-[--light-border]">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="role-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 modal modal-hidden p-4">
         <div id="modal-content-wrapper" class="bg-[--light-bg] shadow-xl w-full max-w-xl mx-auto border border-[--light-border]">
            <div class="flex justify-between items-center p-4 sm:p-5 border-b border-[--light-border] flex-shrink-0">
                <h2 id="modal-title" class="text-xl sm:text-2xl font-header text-[--light-accent1]">Role Details</h2>
                <button id="close-modal-btn" class="text-[--light-text-secondary] hover:text-[--light-text-primary] transition-colors text-3xl sm:text-4xl font-light leading-none">&times;</button>
            </div>
            <div id="modal-body-content" class="p-4 sm:p-5 flex flex-col md:flex-row gap-4">
                <div class="md:w-1/3 flex-shrink-0 text-center">
                    <img id="modal-image" src="https://placehold.co/128x128/EFF6FF/1E3A8A?text=Role" alt="Role Image" class="w-24 h-24 sm:w-32 sm:h-32 mx-auto mb-3 border-2 border-[--light-accent1] shadow-md object-cover">
                </div>
                <div id="modal-description" class="md:w-2/3 text-sm text-[--light-text-primary]">
                    </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
       const orgData = [
            {
                id: 1, name: "CEO / Team President", parentId: null, department: "Management",
                imageUrl: "https://placehold.co/128x128/F59E0B/FFFFFF?text=CEO",
                description: `
                    <p><strong>Role:</strong> Chief Executive Officer (CEO) or Team President.</p>
                    <p><strong>Core Focus:</strong> Sets the overall strategic direction and vision for the organization. Oversees all business operations, including finance, marketing, and administration, ensuring long-term sustainability and success. Represents the team in league matters and major stakeholder interactions.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Define and communicate the organization's overarching strategy and values.</li>
                        <li>Lead all business operations, ensuring financial health and operational efficiency.</li>
                        <li>Act as the primary representative in league discussions and with key external partners.</li>
                        <li>Foster a culture of excellence and accountability across all departments.</li>
                        <li>Ultimately responsible for the organization's public image and financial performance.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Board of Directors/Owners, General Manager, Heads of Departments (Finance, Marketing, Operations, HR).
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 6, Goals Analysis various.</p>`
            },
            {
                id: 2, name: "General Manager / Sporting Director", parentId: 1, department: "Management",
                imageUrl: "https://placehold.co/128x128/F59E0B/FFFFFF?text=GM",
                description: `
                    <p><strong>Role:</strong> General Manager (GM) or Sporting Director.</p>
                    <p><strong>Core Focus:</strong> Manages all aspects of the team's roster and athletic strategy. Accountable for the team's competitive success and long-term athletic development pipeline.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Oversee player acquisitions, trades, and contract negotiations.</li>
                        <li>Hire and manage the Head Coach and often heads of performance/medical departments.</li>
                        <li>Direct scouting departments (professional and amateur) for talent identification.</li>
                        <li>Develop and implement the long-term athletic strategy in alignment with organizational goals.</li>
                        <li>Manage the player salary cap and budget for sporting operations.</li>
                    </ul>
                    <strong>Key Interactions:</strong> CEO/President, Head Coach, Scouting Department, Player Agents, Medical/Performance Heads, Finance Manager.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 6, Goals Analysis (On-Field Perf., Player Dev.).</p>`
            },
            {
                id: 3, name: "Operations Manager / Athletic Director", parentId: 1, department: "Management",
                imageUrl: "https://placehold.co/128x128/F59E0B/FFFFFF?text=Ops",
                description: `
                    <p><strong>Role:</strong> Operations Manager or Athletic Director.</p>
                    <p><strong>Core Focus:</strong> Ensures the smooth and efficient running of all team logistics and operational aspects, allowing coaching and performance staff to focus on athletes.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Manage team logistics: travel, accommodation, scheduling, and event coordination.</li>
                        <li>Oversee facility management (training grounds, stadium operations).</li>
                        <li>Manage equipment procurement, maintenance, and inventory.</li>
                        <li>Ensure compliance with league regulations regarding operations.</li>
                        <li>Coordinate with various departments to support their operational needs.</li>
                    </ul>
                    <strong>Key Interactions:</strong> CEO/President, GM, Head Coach, Travel Coordinators, Facility Staff, Equipment Managers, External Vendors.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 6.</p>`
            },
            {
                id: 4, name: "Finance Manager / CFO", parentId: 1, department: "Management",
                imageUrl: "https://placehold.co/128x128/F59E0B/FFFFFF?text=CFO",
                description: `
                    <p><strong>Role:</strong> Finance Manager or Chief Financial Officer (CFO).</p>
                    <p><strong>Core Focus:</strong> Manages the team's financial resources, ensuring financial stability, compliance, and strategic alignment with organizational goals.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Develop and manage the organization's budget and financial planning.</li>
                        <li>Oversee all financial reporting, accounting, payroll, and cash flow.</li>
                        <li>Manage financial risk and ensure compliance with financial regulations.</li>
                        <li>Analyze financial performance and provide strategic financial advice to leadership.</li>
                        <li>Negotiate and manage sponsorship agreements from a financial perspective.</li>
                    </ul>
                    <strong>Key Interactions:</strong> CEO/President, GM (for player budget), Department Heads, Auditors, Banks.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 6, Goals Analysis (Financial Stability).</p>`
            },
            {
                id: 5, name: "Marketing / PR Manager", parentId: 1, department: "Management",
                imageUrl: "https://placehold.co/128x128/F59E0B/FFFFFF?text=Mktg",
                description: `
                    <p><strong>Role:</strong> Marketing and Public Relations (PR) Manager.</p>
                    <p><strong>Core Focus:</strong> Builds and maintains the team's brand, engages with fans, and manages public image to attract fans, sponsors, and talent.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Develop and execute marketing strategies to build brand awareness and fan loyalty.</li>
                        <li>Manage public relations, media interactions, and all team communications.</li>
                        <li>Oversee social media presence, website content, and advertising campaigns.</li>
                        <li>Manage sponsorship activation and relationships.</li>
                        <li>Organize fan engagement events and initiatives.</li>
                    </ul>
                    <strong>Key Interactions:</strong> CEO/President, GM, Players (for appearances), Media Outlets, Sponsors, Fan Groups.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 6, Goals Analysis (Brand Building).</p>`
            },
            {
                id: 6, name: "Human Resources Manager", parentId: 1, department: "Management",
                imageUrl: "https://placehold.co/128x128/F59E0B/FFFFFF?text=HR",
                description: `
                    <p><strong>Role:</strong> Human Resources (HR) Manager.</p>
                    <p><strong>Core Focus:</strong> Manages all personnel-related functions for non-athletic staff, fostering a positive and productive work environment and ensuring compliance with labor laws.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Manage recruitment, hiring, and onboarding for administrative and support staff.</li>
                        <li>Oversee employee relations, benefits administration, and performance management.</li>
                        <li>Ensure compliance with labor laws and employment regulations.</li>
                        <li>Support organizational development and workplace culture initiatives.</li>
                        <li>May assist with player liaison activities and off-field support.</li>
                    </ul>
                    <strong>Key Interactions:</strong> CEO/President, Department Heads, All Staff, Legal Counsel.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 6.</p>`
            },
            {
                id: 7, name: "Head Coach", parentId: 2, department: "Coaching",
                imageUrl: "https://placehold.co/128x128/10B981/FFFFFF?text=Coach",
                description: `
                    <p><strong>Role:</strong> Head Coach.</p>
                    <p><strong>Core Focus:</strong> Leads all on-field activities, develops game strategies and training methodologies, and motivates players to achieve peak performance and team success.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Direct the entire coaching staff and all on-field player activities.</li>
                        <li>Develop and implement game strategies, tactical plans, and training programs.</li>
                        <li>Make key in-game decisions and player selections/substitutions.</li>
                        <li>Motivate players, foster team cohesion, and cultivate a winning culture.</li>
                        <li>Collaborate closely with the GM on roster decisions and player development.</li>
                        <li>Analyze team and opponent performance with the analysis department.</li>
                    </ul>
                    <strong>Key Interactions:</strong> General Manager, Assistant Coaches, Specialist Coaches, Performance Analysts, Medical Staff, Players.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 3, Goals Analysis (On-Field Perf., Coaching Phil.).</p>`
            },
            {
                id: 8, name: "Assistant Coach (Offense)", parentId: 7, department: "Coaching",
                imageUrl: "https://placehold.co/128x128/10B981/FFFFFF?text=Asst.C",
                description: `
                    <p><strong>Role:</strong> Assistant Coach (e.g., Offensive Coordinator).</p>
                    <p><strong>Core Focus:</strong> Assists the Head Coach with specific areas of game planning (e.g., offense), conducts drills, and contributes to player development within their specialized area.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Design and implement offensive strategies and plays.</li>
                        <li>Conduct drills and provide technical instruction during training sessions.</li>
                        <li>Contribute to player development and performance evaluation, particularly for offensive players.</li>
                        <li>Analyze opponent defenses and prepare offensive game plans.</li>
                        <li>May lead specific positional groups (e.g., quarterbacks, receivers).</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head Coach, Other Assistant Coaches, Players (especially offensive unit).
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 3.</p>`
            },
            {
                id: 9, name: "Assistant Coach (Defense)", parentId: 7, department: "Coaching",
                imageUrl: "https://placehold.co/128x128/10B981/FFFFFF?text=Asst.C",
                description: `
                    <p><strong>Role:</strong> Assistant Coach (e.g., Defensive Coordinator).</p>
                    <p><strong>Core Focus:</strong> Assists the Head Coach with specific areas of game planning (e.g., defense), conducts drills, and contributes to player development within their specialized area.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Design and implement defensive strategies and schemes.</li>
                        <li>Conduct drills and provide technical instruction during training sessions.</li>
                        <li>Contribute to player development and performance evaluation, particularly for defensive players.</li>
                        <li>Analyze opponent offenses and prepare defensive game plans.</li>
                        <li>May lead specific positional groups (e.g., defensive line, linebackers).</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head Coach, Other Assistant Coaches, Players (especially defensive unit).
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 3.</p>`
            },
            {
                id: 10, name: "Specialist Coach (e.g., Goalkeeping)", parentId: 7, department: "Coaching",
                imageUrl: "https://placehold.co/128x128/10B981/FFFFFF?text=Spec.C",
                description: `
                    <p><strong>Role:</strong> Specialist Coach (e.g., Goalkeeping, Set Pieces, Strength & Conditioning - if not separate dept).</p>
                    <p><strong>Core Focus:</strong> Provides highly specialized technical and tactical instruction for specific skills or player positions, designing and implementing tailored training programs.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Deliver expert coaching in a specific area (e.g., goalkeeping techniques, set-piece execution).</li>
                        <li>Design and implement individualized training programs for relevant players.</li>
                        <li>Work individually or with small groups to refine specific skills.</li>
                        <li>Collaborate with Head Coach and other staff on integrating specialist training.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head Coach, Assistant Coaches, Relevant Players, Medical/Performance Staff.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 3.</p>`
            },
            {
                id: 11, name: "Head of Performance Analysis", parentId: 7, department: "Performance Analysis",
                imageUrl: "https://placehold.co/128x128/2563EB/FFFFFF?text=HeadPA",
                description: `
                    <p><strong>Role:</strong> Head of Performance Analysis.</p>
                    <p><strong>Core Focus:</strong> Leads the performance analysis department, establishing workflows for data collection, analysis, and reporting to provide objective insights that inform coaching decisions and enhance player/team performance.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Lead and manage the performance analysis team and resources.</li>
                        <li>Establish and oversee workflows for data collection (video, stats, physiological), analysis, and reporting.</li>
                        <li>Ensure analytical insights are effectively communicated to coaching staff and players.</li>
                        <li>Manage analysis tools, software, and technologies.</li>
                        <li>Oversee pre-match opposition analysis and post-match team performance reviews.</li>
                        <li>Drive innovation in data analysis methodologies within the team.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head Coach, Assistant Coaches, GM, Analysts, Data Scientists, Medical Staff.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 4, Goals Analysis (Perf. Analysis).</p>`
            },
            {
                id: 12, name: "Performance Analyst (Tactical)", parentId: 11, department: "Performance Analysis",
                imageUrl: "https://placehold.co/128x128/2563EB/FFFFFF?text=PA-Tac",
                description: `
                    <p><strong>Role:</strong> Performance Analyst (Tactical Focus).</p>
                    <p><strong>Core Focus:</strong> Analyzes video footage and data to assess tactical execution, scout opponents, and provide detailed reports to coaches for game planning and player feedback.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Analyze video of team training and matches to assess tactical execution and decision-making.</li>
                        <li>Scout upcoming opponents, identifying tactical patterns, strengths, and weaknesses.</li>
                        <li>Create detailed reports, presentations, and video packages for coaches and players.</li>
                        <li>May provide live analysis support during matches.</li>
                        <li>Collaborate with data scientists on integrating advanced metrics into tactical analysis.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head of Performance Analysis, Coaches, Video Analysts, Data Scientists.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 4.</p>`
            },
            {
                id: 13, name: "Data Scientist", parentId: 11, department: "Performance Analysis",
                imageUrl: "https://placehold.co/128x128/2563EB/FFFFFF?text=DataSci",
                description: `
                    <p><strong>Role:</strong> Data Scientist.</p>
                    <p><strong>Core Focus:</strong> Applies advanced statistical methods, machine learning, and data modeling techniques to performance, tracking, and medical data to identify deeper trends, develop predictive models, and provide complex insights.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Develop and apply statistical models and machine learning algorithms to sports data.</li>
                        <li>Create predictive models for player performance, injury risk, or tactical outcomes.</li>
                        <li>Identify complex patterns and insights not apparent through basic analysis.</li>
                        <li>Manage and maintain large datasets and contribute to data infrastructure.</li>
                        <li>Collaborate with analysts and coaches to translate complex findings into actionable insights.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head of Performance Analysis, Performance Analysts, Sports Scientists, Medical Staff.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 4.</p>`
            },
            {
                id: 14, name: "Video Analyst", parentId: 11, department: "Performance Analysis",
                imageUrl: "https://placehold.co/128x128/2563EB/FFFFFF?text=VidAna",
                description: `
                    <p><strong>Role:</strong> Video Analyst.</p>
                    <p><strong>Core Focus:</strong> Films training and matches, codes (tags) key events, manages the video database, and produces video clips to support coaching and performance analysis.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Film training sessions and matches from various angles using appropriate equipment.</li>
                        <li>Code (tag) key events, actions, and tactical information within video footage.</li>
                        <li>Manage and maintain the team's video database, ensuring accessibility.</li>
                        <li>Edit and produce video clips, highlights, and presentations based on analyst/coach requests.</li>
                        <li>Support opponent scouting through video compilation and analysis.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head of Performance Analysis, Performance Analysts, Coaches.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 4.</p>`
            },
             {
                id: 15, name: "Head of Medical & Sports Science", parentId: 7, department: "Medical & Sports Science",
                imageUrl: "https://placehold.co/128x128/EF4444/FFFFFF?text=HeadMed",
                description: `
                    <p><strong>Role:</strong> Head of Medical / Head of Sports Science / High Performance Manager.</p>
                    <p><strong>Core Focus:</strong> Oversees all medical and sports science provisions, developing strategies for injury prevention, rehabilitation, and performance optimization through a multidisciplinary approach.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Lead and manage the medical and sports science staff (physicians, physios, scientists, etc.).</li>
                        <li>Develop and implement evidence-based strategies for injury prevention and rehabilitation.</li>
                        <li>Drive initiatives for athlete performance optimization through scientific principles.</li>
                        <li>Ensure integration of medical/science insights into the coaching process.</li>
                        <li>Manage budgets, resources, and ethical considerations for the department.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head Coach, GM, Team Physician, Lead Physio, Lead Sports Scientist, Players, Performance Analysts.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 5, Goals Analysis (Injury Prev.).</p>`
            },
            {
                id: 16, name: "Team Physician", parentId: 15, department: "Medical & Sports Science",
                imageUrl: "https://placehold.co/128x128/EF4444/FFFFFF?text=Doctor",
                description: `
                    <p><strong>Role:</strong> Team Physician / Doctor.</p>
                    <p><strong>Core Focus:</strong> Provides primary medical care, diagnoses illnesses/injuries, oversees treatment plans, and makes final decisions on player medical availability, prioritizing athlete health.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Conduct medical examinations and diagnose player illnesses and injuries.</li>
                        <li>Develop and oversee treatment and return-to-play protocols.</li>
                        <li>Make final medical decisions on player availability for training and competition.</li>
                        <li>Manage player medical records and ensure compliance with health regulations.</li>
                        <li>Provide medical expertise and counsel to players, coaches, and staff.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head of Medical, Physiotherapists, Players, Head Coach, Specialists (e.g., surgeons).
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 5.</p>`
            },
            {
                id: 17, name: "Athletic Trainer / Physiotherapist", parentId: 15, department: "Medical & Sports Science",
                imageUrl: "https://placehold.co/128x128/EF4444/FFFFFF?text=Physio",
                description: `
                    <p><strong>Role:</strong> Athletic Trainer / Physiotherapist.</p>
                    <p><strong>Core Focus:</strong> Delivers hands-on treatment for injuries, develops and supervises rehabilitation programs, and implements injury prevention strategies. Often the first responder to injuries.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Provide immediate care and assessment for injuries during training and matches.</li>
                        <li>Deliver hands-on treatment, including manual therapy and therapeutic modalities.</li>
                        <li>Develop, implement, and supervise individualized rehabilitation programs.</li>
                        <li>Implement injury prevention strategies (screening, targeted exercises, taping/bracing).</li>
                        <li>Educate athletes on injury management and prevention.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head of Medical, Team Physician, Sports Scientists, Players, Coaches.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 5.</p>`
            },
            {
                id: 18, name: "Sports Scientist", parentId: 15, department: "Medical & Sports Science",
                imageUrl: "https://placehold.co/128x128/EF4444/FFFFFF?text=SportSci",
                description: `
                    <p><strong>Role:</strong> Sports Scientist (Physiology / Biomechanics Focus).</p>
                    <p><strong>Core Focus:</strong> Monitors player physical load, fatigue, and recovery using technology. Conducts fitness testing and provides data-driven recommendations to optimize training and performance while minimizing injury risk.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Monitor player training load, fatigue, and recovery using GPS, heart rate monitors, etc.</li>
                        <li>Conduct regular fitness testing and assess physical performance markers.</li>
                        <li>Provide data-driven recommendations to coaches on training intensity, volume, and periodization.</li>
                        <li>Research and implement best practices in sports science application.</li>
                        <li>Analyze biomechanics to optimize movement efficiency and reduce injury risk.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head of Sports Science/Medical, Physiotherapists, Strength & Conditioning Coaches, Performance Analysts, Coaches, Players.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 5.</p>`
            },
            {
                id: 19, name: "Sports Nutritionist / Dietitian", parentId: 15, department: "Medical & Sports Science",
                imageUrl: "https://placehold.co/128x128/EF4444/FFFFFF?text=Nutrition",
                description: `
                    <p><strong>Role:</strong> Sports Nutritionist / Dietitian.</p>
                    <p><strong>Core Focus:</strong> Develops individualized nutrition plans to optimize performance, recovery, and body composition. Educates players on dietary strategies and supplement use.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Assess individual player nutritional needs and develop personalized meal plans.</li>
                        <li>Educate players on optimal dietary strategies for performance, recovery, and health.</li>
                        <li>Advise on hydration protocols and appropriate, safe supplement use.</li>
                        <li>May oversee team meals, catering, and food provision during travel.</li>
                        <li>Monitor body composition and adjust nutritional strategies accordingly.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head of Medical/Science, Players, Team Physician, Chefs/Catering Staff, Coaches.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 5.</p>`
            },
            {
                id: 20, name: "Sports Psychologist", parentId: 15, department: "Medical & Sports Science",
                imageUrl: "https://placehold.co/128x128/EF4444/FFFFFF?text=Psych",
                description: `
                    <p><strong>Role:</strong> Sports Psychologist / Mental Skills Coach.</p>
                    <p><strong>Core Focus:</strong> Provides psychological support and counseling, teaches mental skills techniques (e.g., goal setting, imagery, stress management) to enhance performance and well-being.</p>
                    <strong>Responsibilities:</strong>
                    <ul>
                        <li>Provide individual and group psychological support and counseling.</li>
                        <li>Teach mental skills (goal setting, visualization, focus, resilience, stress management).</li>
                        <li>Assist with team dynamics, communication, and leadership development.</li>
                        <li>Support players during injury rehabilitation or periods of poor performance.</li>
                        <li>Consult with coaching staff on psychological aspects of performance.</li>
                    </ul>
                    <strong>Key Interactions:</strong> Head of Medical/Science, Players, Coaches, Team Physician.
                    <p class="text-xs italic text-gray-500 mt-2">Source: Org Map Sec. 5.</p>`
            }
        ];

        // --- D3.js Org Chart Logic ---
        let d3Chart = null;
        let d3Zoom = null;

        function drawD3Chart() {
            const chartContainer = document.getElementById('d3-chart-container');
            if (!chartContainer) {
                console.error("D3 chart container not found!");
                return;
            }
            chartContainer.innerHTML = ''; // Clear loader or previous chart
            
            // Add zoom controls to the cleared container
            const zoomControls = document.createElement('div');
            zoomControls.className = 'zoom-controls';
            zoomControls.innerHTML = `
                <button id="zoom-in-btn" class="zoom-btn" title="Zoom In">+</button>
                <button id="zoom-out-btn" class="zoom-btn" title="Zoom Out">−</button>
            `;
            chartContainer.appendChild(zoomControls);

            const containerRect = chartContainer.getBoundingClientRect();
            const effectiveWidth = containerRect.width > 0 ? containerRect.width : 800;
            const effectiveHeight = containerRect.height > 0 ? containerRect.height : 650;

            const margin = { top: 40, right: 20, bottom: 40, left: 20 };
            const width = effectiveWidth - margin.left - margin.right;
            const height = effectiveHeight - margin.top - margin.bottom;

            // Node dimensions & spacing
            const nodeWidth = 170;
            const nodeHeight = 70; 
            const departmentBadgeHeight = 20; 
            const nodeVerticalSpacing = nodeHeight + 50;
            const nodeHorizontalSpacing = nodeWidth + 30;

            const svg = d3.select(chartContainer)
                .append("svg")
                .attr("width", effectiveWidth)
                .attr("height", effectiveHeight)
                .attr("viewBox", [0, 0, effectiveWidth, effectiveHeight]);

            const g = svg.append("g");

            d3Zoom = d3.zoom()
                .scaleExtent([0.15, 3])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            svg.call(d3Zoom);

            const rootNodeId = orgData.find(d => d.parentId === null)?.id;
            if (rootNodeId === undefined) {
                chartContainer.innerHTML = '<p class="text-red-500 p-4 text-center">Error: No root node found.</p>';
                return;
            }

            const stratify = d3.stratify().id(d => d.id).parentId(d => d.parentId);
            let root;
            try {
                root = stratify(orgData);
            } catch (e) {
                console.error("Error creating hierarchy:", e);
                chartContainer.innerHTML = '<p class="text-red-500 p-4 text-center">Error building chart hierarchy.</p>';
                return;
            }

            const treeLayout = d3.tree().nodeSize([nodeHorizontalSpacing, nodeVerticalSpacing]);
            treeLayout(root);

            const descendants = root.descendants();
            const xCoords = descendants.map(d => d.x);
            const yCoords = descendants.map(d => d.y);
            const minX = d3.min(xCoords) - nodeWidth / 2;
            const maxX = d3.max(xCoords) + nodeWidth / 2;
            const minY = d3.min(yCoords) - nodeHeight / 2;
            const maxY = d3.max(yCoords) + nodeHeight / 2;

            const treeActualWidth = maxX - minX;
            const treeActualHeight = maxY - minY;

            const initialScale = Math.min(width / treeActualWidth, height / treeActualHeight, 1) * 0.98;
            const initialX = (effectiveWidth / 2) - ((minX + maxX) / 2 * initialScale);
            const initialY = (effectiveHeight / 2) - ((minY + maxY) / 2 * initialScale);

            svg.call(d3Zoom.transform, d3.zoomIdentity.translate(initialX, initialY).scale(initialScale));

            g.selectAll(".d3-link")
                .data(root.links())
                .join("path")
                .attr("class", "d3-link")
                .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

            const nodes = g.selectAll(".d3-node")
                .data(descendants)
                .join("g")
                .attr("class", "d3-node group cursor-pointer")
                .attr("transform", d => `translate(${d.x - nodeWidth / 2},${d.y - nodeHeight / 2})`)
                .on("click", (event, d) => {
                    showModal(d.data);
                });

            nodes.append("rect")
                .attr("class", "node-rect")
                .attr("width", nodeWidth)
                .attr("height", nodeHeight)
                .attr("fill", "var(--light-bg-secondary)") /* Changed from white to dark background */
                .attr("stroke", d => {
                    const dept = d.data.department;
                    if (dept === "Management") return "var(--light-accent3)";
                    if (dept === "Coaching") return "var(--light-accent2)";
                    if (dept === "Performance Analysis") return "var(--light-accent5)"; /* Updated to use yellow for analysis */
                    if (dept === "Medical & Sports Science") return "var(--light-accent4)";
                    return "var(--light-border)";
                });
            
            const textBlockWidth = nodeWidth - 12; /* Reduced padding from 20 to 12 */
            const spaceForText = nodeHeight - departmentBadgeHeight - 20; /* Increased gap from 15 to 20 */
            const textY = 8 + (spaceForText - 8) / 2; /* Reduced top padding, center text in available space */ 

            nodes.append("text")
                .attr("class", "node-name")
                .attr("x", nodeWidth / 2) 
                .attr("y", textY) 
                .attr("text-anchor", "middle") 
                .text(d => d.data.name)
                .call(wrapTextD3, textBlockWidth, 2, 14, spaceForText); /* Pass available height */ 

            const badgeY = nodeHeight - departmentBadgeHeight - 5; /* Reduced bottom padding from 7 to 5 */ 
            nodes.append("rect")
                .attr("class", d => `badge-fill-${getBadgeClass(d.data.department, true)}`)
                .attr("x", 6) /* Reduced side padding from 7 to 6 */
                .attr("y", badgeY)
                .attr("width", nodeWidth - 12) /* Adjusted width to match reduced padding */
                .attr("height", departmentBadgeHeight)
                .attr("rx", 0).attr("ry", 0); /* Removed corner radius for 90 degree corners */

            nodes.append("text")
                .attr("class", "node-department-text")
                .attr("x", nodeWidth / 2)
                .attr("y", badgeY + departmentBadgeHeight / 2) 
                .attr("text-anchor", "middle")
                .text(d => d.data.department || "N/A");

            d3Chart = { svg, g, root, nodes, links: g.selectAll(".d3-link") };
            
            // Set up zoom controls after chart is drawn
            setupZoomControls();
        }

        function wrapTextD3(textElements, width, maxLines = 2, explicitLineHeight = 14, maxHeight = null) {
            textElements.each(function() {
                let text = d3.select(this),
                    words = text.text().split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    x = text.attr("x"), 
                    y = parseFloat(text.attr("y")),
                    tspan = text.text(null).append("tspan").attr("x", x).attr("y", y);

                let originalTextContent = textElements.text(); 
                let estimatedLines = 1;
                let tempSvgForMeasurement = d3.select(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
                let tempMeasurementTextNode = tempSvgForMeasurement.append("text")
                                            .attr("class", text.attr("class")) 
                                            .style("font-size", text.style("font-size")) 
                                            .style("font-weight", text.style("font-weight"));
                
                let currentLineForEstimation = "";
                let tempWordsForEstimation = originalTextContent.split(/\s+/);

                for(let k=0; k < tempWordsForEstimation.length; k++){ 
                    let testLine = currentLineForEstimation ? currentLineForEstimation + " " + tempWordsForEstimation[k] : tempWordsForEstimation[k];
                    tempMeasurementTextNode.text(testLine);
                    if(tempMeasurementTextNode.node() && tempMeasurementTextNode.node().getComputedTextLength() > width && currentLineForEstimation){
                        estimatedLines++;
                        currentLineForEstimation = tempWordsForEstimation[k];
                    } else {
                        currentLineForEstimation = testLine;
                    }
                }
                // If maxHeight is provided, ensure we don't exceed it
                if (maxHeight && estimatedLines * explicitLineHeight > maxHeight) {
                    estimatedLines = Math.floor(maxHeight / explicitLineHeight);
                }
                estimatedLines = Math.min(maxLines, estimatedLines);
                tempSvgForMeasurement.remove();

                let yInitialAdjust = 0;
                if (estimatedLines === 1 && maxLines > 1) { 
                    yInitialAdjust = explicitLineHeight / 3.5; 
                } else if (estimatedLines > 1) { 
                     yInitialAdjust = - ( (estimatedLines -1) * explicitLineHeight) / 2 + (explicitLineHeight / 3.5) ; 
                }
                tspan.attr("y", y + yInitialAdjust);


                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(" "));
                    if (tspan.node().getComputedTextLength() > width && line.length > 1) {
                        line.pop();
                        tspan.text(line.join(" "));
                        if (lineNumber < maxLines - 1) {
                            lineNumber++;
                            line = [word];
                            tspan = text.append("tspan").attr("x", x).attr("dy", explicitLineHeight + "px").text(word);
                        } else {
                            let currentText = tspan.text();
                            while (tspan.node().getComputedTextLength() > width - 10 && currentText.length > 3) { 
                                currentText = currentText.slice(0, -1);
                            }
                            tspan.text(currentText.trim() + (currentText.endsWith("...") || words.length === 0 ? "" : "..."));
                            break;
                        }
                    }
                }
            });
        }

        // --- Table View Population ---
        const tableBody = document.querySelector('#roles-table tbody');
        function populateTable() {
            if (!tableBody) return;
            tableBody.innerHTML = '';
            orgData.forEach(role => {
                const parentRole = orgData.find(p => p.id === role.parentId);
                const parentName = parentRole ? parentRole.name : 'N/A';
                const row = document.createElement('tr');
                row.classList.add('hover:bg-[--light-bg-secondary]', 'clickable-row', 'transition-colors', 'duration-150');
                row.setAttribute('data-role-id', role.id.toString());
                row.setAttribute('tabindex', '0');
                const badgeHTML = role.department ? `<span class="dept-badge ${getBadgeClass(role.department)}">${role.department}</span>` : '<span class="text-[--light-text-secondary]">N/A</span>';
                row.innerHTML = `
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-medium text-[--light-text-primary] whitespace-nowrap">${role.name}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm text-[--light-text-secondary] whitespace-nowrap">${parentName}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm text-[--light-text-secondary]">${badgeHTML}</td>
                `;
                row.addEventListener('click', () => { showModal(role); });
                row.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showModal(role); }
                });
                tableBody.appendChild(row);
            });
        }

        function getBadgeClass(department, forD3Fill = false) {
            const baseClass = String(department).toLowerCase().replace(/ & /g, '-').replace(/ /g, '-');
            if (forD3Fill) {
                switch (baseClass) {
                    case 'coaching': return 'coaching'; /* Maps to green #53DA3F */
                    case 'medical-sports-science': return 'medical'; /* Maps to red #FF421D */
                    case 'management': return 'management'; /* Maps to orange #FF7300 */
                    case 'performance-analysis': return 'performance'; /* Maps to yellow #FFDD00 */
                    default: return 'default'; /* Maps to gray #6A727E */
                }
            } else {
                 switch (baseClass) {
                    case 'coaching': return 'badge-coaching'; /* Green background #53DA3F */
                    case 'medical-sports-science': return 'badge-medical'; /* Red background #FF421D */
                    case 'management': return 'badge-management'; /* Orange background #FF7300 */
                    case 'performance-analysis': return 'badge-performance'; /* Yellow background #FFDD00 */
                    default: return 'badge-default'; /* Gray background #6A727E */
                }
            }
        }

        // --- View Switching Logic ---
        const chartView = document.getElementById('chart-view');
        const tableView = document.getElementById('table-view');
        const showChartBtn = document.getElementById('show-chart-btn');
        const showTableBtn = document.getElementById('show-table-btn');
        let d3ChartDrawnOnce = false;

        function setActiveButtonStyles(activeBtn, inactiveBtn) {
            if (!activeBtn || !inactiveBtn) return;
            activeBtn.classList.remove('inactive'); activeBtn.classList.add('active');
            inactiveBtn.classList.remove('active'); inactiveBtn.classList.add('inactive');
        }

        if (showChartBtn) {
            showChartBtn.addEventListener('click', () => {
                if (chartView && tableView) {
                    chartView.classList.remove('hidden-view'); chartView.classList.add('visible-view');
                    tableView.classList.add('hidden-view'); tableView.classList.remove('visible-view');
                    setActiveButtonStyles(showChartBtn, showTableBtn);
                    if (!d3ChartDrawnOnce) {
                        setTimeout(() => {
                            drawD3Chart();
                        }, 50);
                        d3ChartDrawnOnce = true;
                    }
                }
            });
        }

       if (showTableBtn) {
            showTableBtn.addEventListener('click', () => {
                 if (chartView && tableView) {
                    tableView.classList.remove('hidden-view'); tableView.classList.add('visible-view');
                    chartView.classList.add('hidden-view'); chartView.classList.remove('visible-view');
                    setActiveButtonStyles(showTableBtn, showChartBtn);
                 }
            });
        }

        // --- Modal Logic ---
        const modal = document.getElementById('role-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalImage = document.getElementById('modal-image');
        const modalDescription = document.getElementById('modal-description');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalBodyContent = document.getElementById('modal-body-content');
        let previouslyFocusedElement = null;

        function showModal(roleData) {
            if (!roleData || !modal || !modalTitle || !modalDescription || !modalImage || !modalBodyContent) return;
            previouslyFocusedElement = document.activeElement;
            modalTitle.textContent = roleData.name;
            modalImage.src = roleData.imageUrl || 'https://placehold.co/128x128/EFF6FF/1E3A8A?text=Role';
            modalImage.alt = roleData.name;
            modalDescription.innerHTML = roleData.description || '<p>No detailed description available for this role.</p>';
            modal.classList.remove('modal-hidden'); modal.classList.add('modal-visible');
            modalBodyContent.scrollTop = 0;
            closeModalBtn.focus();
        }

        function hideModal() {
            if (!modal) return;
            modal.classList.add('modal-hidden'); 
            modal.classList.remove('modal-visible'); // Corrected this line
            if (previouslyFocusedElement) previouslyFocusedElement.focus();
        }

        if(closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
        if(modal) {
            modal.addEventListener('click', (event) => { if (event.target === modal) hideModal(); });
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal?.classList.contains('modal-visible')) hideModal();
            if (event.key === 'Tab' && modal?.classList.contains('modal-visible')) {
                const focusableElements = Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(el => el.offsetParent !== null);
                if (focusableElements.length === 0) return;
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];
                if (event.shiftKey) {
                    if (document.activeElement === firstElement) { lastElement.focus(); event.preventDefault(); }
                } else {
                    if (document.activeElement === lastElement) { firstElement.focus(); event.preventDefault(); }
                }
            }
        });

        // --- App Initialization ---
        function initializeApp() {
            populateTable();
            const isMobile = window.innerWidth < 768;
            if (isMobile && tableView && chartView && showTableBtn && showChartBtn) {
                tableView.classList.remove('hidden-view'); tableView.classList.add('visible-view');
                chartView.classList.add('hidden-view'); chartView.classList.remove('visible-view');
                setActiveButtonStyles(showTableBtn, showChartBtn);
            } else if (chartView && tableView && showChartBtn && showChartBtn) {
                chartView.classList.remove('hidden-view'); chartView.classList.add('visible-view');
                tableView.classList.add('hidden-view'); tableView.classList.remove('visible-view');
                setActiveButtonStyles(showChartBtn, showTableBtn);
                setTimeout(() => {
                    drawD3Chart();
                }, 50);
                d3ChartDrawnOnce = true;
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

        // Zoom control functions
        function setupZoomControls() {
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            
            if (zoomInBtn && zoomOutBtn && d3Zoom) {
                zoomInBtn.addEventListener('click', () => {
                    if (d3Chart && d3Chart.svg) {
                        d3Chart.svg.transition().duration(200).call(d3Zoom.scaleBy, 1.5);
                    }
                });
                
                zoomOutBtn.addEventListener('click', () => {
                    if (d3Chart && d3Chart.svg) {
                        d3Chart.svg.transition().duration(200).call(d3Zoom.scaleBy, 1 / 1.5);
                    }
                });
            }
        }

        // Handle window resize for D3 chart
        let resizeD3Timeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeD3Timeout);
            resizeD3Timeout = setTimeout(() => {
                if (d3ChartDrawnOnce && chartView.classList.contains('visible-view')) {
                    const chartContainer = document.getElementById('d3-chart-container');
                    chartContainer.innerHTML = '<div class="chart-loading-container"><div class="loader"></div><p>Adjusting Chart...</p></div>';
                    drawD3Chart();
                }
            }, 300);
        });

    </script>
</body>
</html>
